{% extends "dsfr/base.html" %}
{% load static %}
{% block extra_css %}
	<script src="https://unpkg.com/htmx.org@1.9.10"
	        integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
	        crossorigin="anonymous"></script>
	<script src="https://unpkg.com/htmx.org/dist/ext/debug.js"></script>
	<script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
	<link rel="stylesheet" href="{% static 'css/stylesheet.css' %}">
{% endblock %}
{% block header %}
	{% include "dsfr/header.html" %}
{% endblock header %}
{% block content %}
	<div id="loader" style="display: none;">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>Chargement...</p>
        </div>
    </div>
	<dialog aria-labelledby="fr-modal-title-modal-book" role="alertdialog" id="fr-modal-book" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn--close fr-btn" title="Fermer la fenêtre modale"
                                    aria-controls="fr-modal-book">Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-title-modal-book" class="fr-modal__title"><span
		                            class="fr-icon-arrow-right-line fr-icon--lg"></span>Titre de la modale
                            </h1>
                            <div class="modal__body fr-container">
                                <form id="bookModalForm" hx-put="{% url 'book-detail' %}" hx-swap="none">
	                                {% csrf_token %}
                                    <div class="fr-input-group">
                                        <label class="fr-label" for="text-input-groups-book__title">Titre
                                            <span class="fr-hint-text">Titre du livre</span>
                                        </label>
                                        <input class="fr-input" type="text" id="text-input-groups-book__title"
                                               name="text-input-book__title" required minlength="3">
                                    </div>
                                    <div class="fr-input-group">
                                        <label class="fr-label" for="text-input-groups-book__author">Prénom
                                            <span class="fr-hint-text">Prénom de l'auteur du livre</span>
                                        </label>
                                        <input class="fr-input" type="text" id="text-input-groups-book__author"
                                               name="text-input-book__author" required minlength="3">
                                    </div>
                                    <div class="fr-input-group">
                                        <label class="fr-label" for="text-input-groups-book__year">Année de parution
                                            <span class="fr-hint-text">Année de parution du livre</span>
                                        </label>
                                        <input class="fr-input" type="date" id="text-input-groups-book__year"
                                               name="text-input-book__year" required>
                                    </div>
                                    <div class="fr-input-group">
                                        <label class="fr-label" for="text-input-groups-book__pages">Nombre de pages
                                            <span class="fr-hint-text">Nombre de pages du livre</span>
                                        </label>
                                        <input class="fr-input" type="number"
                                               id="text-input-groups-book__pages"
                                               name="text-input-book__pages" required>
                                    </div>
                                    <div class="fr-input-group">
                                        <label class="fr-label" for="text-input-groups-book__price">Prix
                                            <span class="fr-hint-text">Prix du livre (Optionnel)</span>
                                        </label>
                                        <input class="fr-input" type="number" id="text-input-groups-book__price"
                                               name="text-input-book__price" step=".01">
                                    </div>
                                </form>
                            </div>
                        </div>
	                    <div class="fr-modal__footer">
	                        <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
	                            <button type="submit" form="bookModalForm"
	                                    class="fr-btn fr-icon-checkbox-circle-line fr-btn--icon-left">
	                                Valider
	                            </button>
	                            <button class="fr-btn fr-icon-close-circle-line fr-btn--icon-left fr-btn--secondary"
	                                    onclick="formResetDefaultValue(modalBookForm, modalBookFormDefaultValue)">
	                                Réinitialiser
	                            </button>
	                        </div>
	                    </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
	<button hidden="hidden" data-fr-opened="false" aria-controls="fr-modal-book"></button>
	
	<div class="fr-container">
        <div class="fr-grid-row fr-grid-row--center">
            <div id="book-table-index" class="fr-table" hx-get="{% url 'book_table_index' %}"
                 hx-trigger="load, htmx:afterOnRequest"
                 hx-target="#book-table-index tbody">
	            <table>
			        <caption>Tableau des livres de la BD</caption>
			        <thead>
			            <tr>
			                <th scope="col">Titre</th>
			                <th scope="col">Auteur</th>
			                <th scope="col">Date de parution</th>
			                <th scope="col">Nombre de pages</th>
			                <th scope="col">Prix</th>
			                <th scope="col"></th>
			            </tr>
			        </thead>
			        <tbody></tbody>
			    </table>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
	<script defer>
		const apiUrlBookFormFieldValidation = "{% url 'book-form-field-validation' %}";
		
		const modalBook = document.getElementById('fr-modal-book');
		const modalBookForm = document.getElementById('bookModalForm');
		var modalBookFormDefaultValue = {};
		
		/*
		 * Event listener pour le formulaire de la modale
		 * @param {Object} form - Formulaire de la modale
		 * @returns {Promise<void>}
		 * @constructor
		 *
		 * @event htmx:configRequest
		 */
		function formSubmitEventListener(form) {
			// On ajoute un listener sur le formulaire de la modale pour configurer la requête envoyée par htmx
			// avant de l'envoyer
			form.addEventListener('htmx:configRequest', function (event) {
				// Fonction qui permet de transformer les clés du JSON envoyé par le formulaire
				// en clé attendue par l'API (ex : text-input-book__title devient title)
				// Il convertit également la date au format attendu par l'API (ex : 2021-01-01 devient 01-01-2021)
				for (const [key, value] of Object.entries(event.detail.parameters)) {
					// Si la clé contient 'text-input-'
					if (key.includes('text-input-')) {
						// Si la clé est une date (c'est-à-dire si elle contient 'year'), on la transforme en clé
						// attendue par l'API, et on modifie la valeur si c'est une date
						// pour la mettre au format attendu par l'API
						if (key.includes('year')) {
							event.detail.parameters[key.split('__')[1]] = value.split('-').reverse().join('-');
						} else {
							// Sinon, on transforme la clé en clé attendue par l'API
							event.detail.parameters[key.split('__')[1]] = value;
						}
						// On supprime l'ancienne clé
						delete event.detail.parameters[key];
					}
				}
			});
			
			// On ajoute un listener sur le formulaire de la modale pour gérer l'événement après la requête
			form.addEventListener('htmx:afterRequest', () => {
				// On cache la modale
				dsfr(modalBook).modal.conceal();
				// On actualise le tableau des livres
				htmx.trigger('#book-table-index', 'htmx:afterOnRequest');
			});
		}
		
		/*
		 * Fonction qui permet de récupérer les données d'un livre et de les afficher dans la modale
		 * @param {Object} event - Événement déclenché par le clic sur un bouton
		 * @returns {Promise<void>}
		 * @constructor
		 */
		function showBookModalAndUpdateInputFields(event) {
			// On écoute récupère l'attribut hx-get du bouton sur lequel on a cliqué
			fetch(event.target.getAttribute('hx-get'))
					.then(response => response.text())
					// On récupère les données du livre
					.then(data => {
						// On met à jour les champs du formulaire avec les données du livre
						formUpdateInputFieldsValue(modalBookForm, JSON.parse(data));
						// On enlève les anciennes erreurs ou validations du formulaire
						modalBookForm.querySelectorAll('.fr-input-group').forEach(
								divInputGroup => formValidationClear(divInputGroup)
						);
						// On sauvegarde nous-mêmes les nouvelles valeurs par défaut du formulaire pour
						formSaveDefaultValue(modalBookForm, JSON.parse(data));
						// On affiche la modale
						dsfr(modalBook).modal.disclose();
					})
					// Si une erreur se produit, on l'affiche dans la console
					.catch(error => console.error("Une erreur s'est produite : ", error));
		}
		
		/*
		 * Fonction qui permet de mettre à jour les champs du formulaire avec les données du livre
		 * @param {Object} form - Formulaire de la modale
		 * @param {Object} data - Données du livre
		 * @returns {void}
		 * @constructor
		 */
		function formUpdateInputFieldsValue(form, data) {
			// On récupère l'attribut hx-put du formulaire
			const formLink = form.getAttribute('hx-put');
			// On crée une regex pour vérifier si l'attribut hx-put se termine par un chiffre
			// ex : /api/books/1/ la regex va matcher
			// ex : /api/books/ la regex ne va pas matcher
			var regex = /\d\/$/;
			
			// Si l'attribut hx-put se termine par un chiffre
			if (regex.test(formLink)) {
				// On remplace le chiffre par l'id du livre
				form.setAttribute('hx-put', formLink.substring(0, formLink.lastIndexOf('/', formLink.length - 2) + 1) + data.id + '/');
			} else {
				// Sinon, on ajoute l'id du livre à la fin de l'attribut hx-put
				form.setAttribute('hx-put', formLink + data.id +'/');
			}
			
			// On met à jour les champs du formulaire avec les données du livre
			form.querySelectorAll('.fr-input-group').forEach(
					divInputGroup => {
						const input = divInputGroup.querySelector('input');
						input.value = data[input.getAttribute('name').split('__')[1]];
					}
			);
			// On réactualise htmx pour qu'il prenne en compte les nouvelles valeurs des champs du formulaire
			htmx.process(form);
		}
		
		/*
		 * Fonction qui permet de sauvegarder les valeurs par défaut du formulaire
		 * @param {Object} form - Formulaire de la modale
		 * @param {Object} data - Données du livre
		 * @returns {void}
		 * @constructor
		 */
		function formSaveDefaultValue(form, data) {
			// On sauvegarde les valeurs par défaut du formulaire
			form.querySelectorAll('.fr-input-group').forEach(
					divInputGroup => {
						const input = divInputGroup.querySelector('input');
						modalBookFormDefaultValue[input.getAttribute('name')] = data[input.getAttribute('name').split('__')[1]]
					}
			);
		}
		
		/*
		 * Fonction qui permet de réinitialiser les valeurs par défaut du formulaire
		 * @param {Object} form - Formulaire de la modale
		 * @param {Object} data - Données du livre
		 * @returns {void}
		 * @constructor
		 */
		function formResetDefaultValue(form, data) {
			// On réinitialise les valeurs par défaut du formulaire
			form.querySelectorAll('.fr-input-group').forEach(
					divInputGroup => {
						formValidationClear(divInputGroup);
						const input = divInputGroup.querySelector('input');
						input.value = data[input.getAttribute('name')];
					}
			);
			
		}
		
		/*
		 * Event listener pour la validation des champs du formulaire
		 * @param {Object} form - Formulaire de la modale
		 * @param {String} apiVerificationLink - Lien de l'API pour la validation des champs du formulaire
		 * @returns {Promise<void>}
		 * @constructor
		 */
		function formValidationEventListener(form, apiVerificationLink) {
			// On ajoute un listener sur le formulaire de la modale pour valider les champs du formulaire 
			// lorsqu'un champ est modifié
			form.addEventListener('input', async (event) => {
				await formValidationLogic(event.target, apiVerificationLink);
			});
			
			{% comment %}form.querySelectorAll('input').forEach(input => {
				input.addEventListener('blur', async (event) => {
					await formValidationLogic(event.target, apiVerificationLink);
				});
			});{% endcomment %}
		}
		
		/*
		 * Fonction qui permet de valider les champs du formulaire
		 * @param {Object} input - Champ du formulaire
		 * @param {String} apiVerificationLink - Lien de l'API pour la validation des champs du formulaire
		 * @returns {Promise<void>}
		 * @constructor
		 */
		async function formValidationLogic(input, apiVerificationLink) {
			// On récupère le nom du champ du formulaire
			const inputName = input.getAttribute('name');
			var formBody;
			
			// On vérifie si le champ est une date
			if (input.type === 'date') {
				// Si c'est une date, on la transforme en clé attendue par l'API
				formBody = JSON.stringify({[inputName.split('__')[1]]: input.value.split('-').reverse().join('-')})
			} else {
				// Sinon, on transforme le champ en clé attendue par l'API
				formBody = JSON.stringify({[inputName.split('__')[1]]: input.value});
			}
			
			// On envoie une requête à l'API pour valider le champ du formulaire
			try {
				const response = await fetch(apiVerificationLink, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: formBody
				})
				const divInputGroup = input.parentElement;
				if (response.ok) {
					// Si le champ est valide, on affiche un message de validation
					formValidationSuccess(divInputGroup);
				} else {
					// Si le champ n'est pas valide, on affiche un message d'erreur
					const errors = await response.json();
					formValidationError(divInputGroup, errors);
				}
				// Si une erreur se produit, on l'affiche dans la console
			} catch (error) {
				console.error("Une erreur s'est produite : ", error);
			}
		}
		
		/*
		 * Fonction qui permet d'afficher un message de validation
		 * @param {Object} divInputGroup - Groupe de champs du formulaire
		 * @returns {void}
		 * @constructor
		 */
		function formValidationSuccess(divInputGroup) {
			// Si le champ contenait une erreur, on l'enlève
			if (divInputGroup.classList.contains('fr-input-group--error')) {
				formValidationClear(divInputGroup);
			}
			// On ajoute un message de validation
			var input = divInputGroup.querySelector('input');
			divInputGroup.classList.add('fr-input-group--valid');
			divInputGroup.classList.add('show');
			input.classList.add('fr-input--valid');
			input.classList.add('show');
			input.setAttribute('aria-describedby', `${input.getAttribute('type')}-input-valid-desc-valid`);
			
			if (!divInputGroup.querySelector('p.fr-valid-text')) {
				var spanValid = document.createElement('p');
				spanValid.className = 'fr-valid-text show';
				spanValid.textContent = "Le champ est valide";
				divInputGroup.appendChild(spanValid);
			}
		}
		
		/*
		 * Fonction qui permet de réinitialiser les messages d'erreur ou de validation
		 * @param {Object} divInputGroup - Groupe de champs du formulaire
		 * @returns {void}
		 * @constructor
		 */
		function formValidationClear(divInputGroup) {
			divInputGroup.classList.remove('fr-input-group--valid');
			divInputGroup.classList.remove('fr-input-group--error');
			divInputGroup.classList.remove('show');
			
			var input = divInputGroup.querySelector('input');
			input.classList.remove('fr-input--valid');
			input.classList.remove('fr-input--error');
			input.classList.remove('show');
			input.removeAttribute('aria-describedby');
			
			if (divInputGroup.querySelector('p.fr-error-text')) {
				divInputGroup.querySelector('p.fr-error-text').remove();
			} else if (divInputGroup.querySelector('p.fr-valid-text')) {
				divInputGroup.querySelector('p.fr-valid-text').remove();
			}
		}
		
		/*
		 * Fonction qui permet d'afficher un message d'erreur
		 * @param {Object} divInputGroup - Groupe de champs du formulaire
		 * @param {Object} errors - Erreurs du champ du formulaire
		 * @returns {void}
		 * @constructor
		 */
		function formValidationError(divInputGroup, errors) {
			if (divInputGroup.classList.contains('fr-input-group--valid')) {
				formValidationClear(divInputGroup);
			}
			var input = divInputGroup.querySelector('input');
			divInputGroup.classList.add('fr-input-group--error');
			divInputGroup.classList.add('show');
			input.classList.add('fr-input--error');
			input.classList.add('show');
			input.setAttribute('aria-describedby', `${input.getAttribute('type')}-input-error-desc-error`);
			
			if (!divInputGroup.querySelector('p.fr-error-text')) {
				var spanError = document.createElement('p');
				spanError.className = 'fr-error-text show';
				spanError.textContent = errors[Object.keys(errors)[0]];
				divInputGroup.appendChild(spanError);
			}
		}
		
		formSubmitEventListener(modalBookForm);
		formValidationEventListener(modalBookForm, apiUrlBookFormFieldValidation);
	</script>
{% endblock %}